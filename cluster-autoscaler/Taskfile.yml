version: 3

tasks:
  build:
    cmds:
      - make build BUILD_TAGS=kloudlite
      # - upx ./cluster-autoscaler-amd64

  docker:build:
    preconditions:
      - sh: '[[ ! -z "{{.TAG}}" ]]'
        msg: 'var TAG must be set'
    env:
      GOARCH: amd64
    vars:
      IMAGE: ghcr.io/kloudlite/cluster-autoscaler
    cmds:
      - task: build
      - |+
        make make-image BUILD_TAGS=kloudlite IMAGE="{{.IMAGE}}" TAG={{.TAG}}
        docker push {{.IMAGE}}-$GOARCH:{{.TAG}}

  run:
    env:
      GOARCH: amd64
    preconditions:
      - sh: '[[ ! -z "$KUBECONFIG" ]]'
        msg: 'env var KUBECONFIG must be set'
    cmds:
      - task: build
      - ./cluster-autoscaler-$GOARCH --kubeconfig="$KUBECONFIG" --cloud-provider=kloudlite --logtostderr=true --stderrthreshold=info -v=4 --expander=random --scale-down-unneeded-time 1m
